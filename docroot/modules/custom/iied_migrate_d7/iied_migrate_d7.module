<?php

/**
 * @file
 * Module for altering the migration source properties in prepareRow().
 */

use Drupal\migrate\Plugin\MigrationInterface;
use Drupal\migrate\Plugin\MigrateSourceInterface;
use Drupal\migrate\Row;
use Drupal\redirect\Entity\Redirect;

/**
 * Implements hook_migrate_prepare_row().
 */
function iied_migrate_d7_migrate_prepare_row(Row $row, MigrateSourceInterface $source, MigrationInterface $migration) {

  $themes_migrations = [
    'iied_d7_projects',
    'iied_d7_articles',
    'iied_d7_blogs',
    'iied_d7_events',
    'iied_d7_news_media',
    'iied_d7_terms_collection',
    'iied_d7_terms_person',
    'iied_d7_projects_translations',
  ];
  if (in_array($migration->id(), $themes_migrations) ) {
    // Themes are already in the pubs site, so quickest to simply map the term
    // ids for now.
    $themes_map = [
      '648' => '4436', // Biodiversity
      '642' => '4441', // Climate change
      '1553' => '4446', // Communication
      '1843' => '4451', // Drylands and pastoralism
      '634' => '4456', // Economics
      '653' => '4461', // Energy
      '2137' => '4466', // Fisheries
      '651' => '4471', // Food and agriculture
      '643' => '4476', // Forests
      '1269' => '4481', // Gender
      '645' => '4486', // Governance
      '647' => '4491', // Green economy
      '649' => '4496', // Land acquisitions and rights
      '652' => '4501', // Law
      '2491' => '4546', // Monitoring, evaluation and learning
      '646' => '4506', // Natural resource management
      '1268' => '4516', // Policy and planning
      '635' => '4521', // Poverty
      '633' => '4531', // Sustainable markets
      '641' => '4536', // Urban
      '644' => '4541', // Water
    ];
    // Get the source terms array.
    $theme_terms = $row->getSourceProperty('taxonomy_vocabulary_19');
    if (is_array($theme_terms)) {
      foreach ($theme_terms as $key => $term) {
        $new_terms[$key]['tid'] = $themes_map[$term['tid']];
      }
      // Set the new mapped values
      $row->setSourceProperty('taxonomy_vocabulary_19', $new_terms);
    }

    // Tags
    $tags_terms = $row->getSourceProperty('taxonomy_vocabulary_15');
    $new_tags = [];
    if (is_array($tags_terms)) {
      foreach ($tags_terms as $key => $term) {
        // Look up the mapped id from the migrate_map_iied_tags table.
        $db = \Drupal\Core\Database\Database::getConnection();
        $query = $db->select('migrate_map_iied_tags', 'mm');
        $query->fields('mm', array('destid1'));
        $query->condition('sourceid1', "https://www.iied.org/taxonomy/term/" . $term['tid']);
        $new_tag = $query->execute()->fetchField();
        // Not all tags have been migrated.
        // @todo - check if we can re-run tags migration first.
        if ($new_tag) {
          $new_tags[$key]['tid'] = $new_tag;
        }
      }
      // Set the new mapped values
      $row->setSourceProperty('taxonomy_vocabulary_15', $new_tags);
    }

    // Use user reference to look up user name to map to the person taxonomy.
    // $project_contacts = [];
    // $project_contacts = $row->getSourceProperty('field_project_contact');
    // if ($project_contacts && count($project_contacts)) {
    //   foreach ($project_contacts as $project_contact) {
    //     $user_id = $project_contact['target_id'];
    //         $author_name = $source->getDatabase()->query('SELECT name FROM {users} WHERE uid = :uid', array(':uid' => $user_id))->fetchField();
    //       $row->setSourceProperty('field_project_contact', $author_name);
    //   }
    // }
  }

  // iied_d7_field_paragraphs, ignoring some paragraphs.
  if ($migration->id() == 'iied_d7_field_paragraphs') {

    $paragraphs_to_ignore = [
      'colorbox_gallery',
      'colorbox_gallery_thumbnails',
    ];
    if (in_array($row->getSourceProperty('bundle'), $paragraphs_to_ignore)) {
      return FALSE;
    }
    if ($row->getSourceProperty('bundle') == 'video_embed_standard') {
      // We are not meant to be using video_embed_standard, but there are a few
      // paragraphs of this type use in articles. They can be migrated to the
      // video_embed paragraph, which has the same fields.
      $row->setSourceProperty('bundle', 'video_embed');
    }
    if ($row->getSourceProperty('bundle') == 'related_link') {
      $url = $row->getSourceProperty('field_related_link_url');
      $title = $row->getSourceProperty('field_related_link_title');
      $related_link_processed[0] = [
        'url' => trim($url),
        'title' => $title,
        'attributes' => '',
      ];
      $row->setSourceProperty('related_link_processed', $related_link_processed);
    }
    // We have file upload paragraphs with multiple rows in one paragraph.
    // We need to process this separately.

    if ($row->getSourceProperty('bundle') == 'file_upload' ) {
      // Load all the files and generate the array of sources.
      $item_id = $row->getSourceProperty('item_id');
      $file_ids = $source->getDatabase()->query('SELECT upload_fid FROM {field_data_upload} WHERE entity_id = :entity_id', array(':entity_id' => $item_id))->fetchCol();
      foreach ($file_ids as $key => $value) {
        $target_file_ids [$key]['target_id'] = $value;
      }
      $row->setSourceProperty('upload_fid_prepared', $target_file_ids);
    }

  }

  // iied_d7_blogs migration. We need to lookup person terms to reference as
  // authors rather than the original user reference.
  if ($migration->id() == 'iied_d7_blogs') {

    $blog_authors = [];
    $author_names = [];
    $author_uid = $row->getSourceProperty('node_uid');
    if ($author_uid) {
      $blog_authors[] = $author_uid;
    }
    $second_authors = $row->getSourceProperty('field_second_author');
    if ($second_authors && count($second_authors)) {
      foreach ($second_authors as $second_author) {
        $blog_authors[] = $second_author['target_id'];
      }
    }
    foreach ($blog_authors as $blog_author) {
      $author_names[] = $source->getDatabase()->query('SELECT name FROM {users} WHERE uid = :uid', array(':uid' => $blog_author))->fetchField();
    }
    $row->setSourceProperty('field_authors', $blog_authors);

  }

  // iied_d7_terms_person migration, users migrating to the person taxonomy.
  if ($migration->id() == 'iied_d7_terms_person') {
    $name = $row->getSourceProperty('name');
    $term = taxonomy_term_load_multiple_by_name($name, $vocabulary = 'person');
    if (count($term)) {
      $tid = array_key_first($term);
      $row->setSourceProperty('tid', $tid);
    }
    // Split name into first name last name based on spaces.
    $names = explode(' ', $name);
    $row->setSourceProperty('first_name', $names[0]);
    $researcher_profiles = $row->getSourceProperty('field_researcher_profiles');
    // Determine the value for the new person_type taxonomy term. This replaces
    // the previous boolean fields for staff, guest and former staff.
    $field_list = $row->getSourceProperty('field_list');
    $field_guest_contributor = $row->getSourceProperty('field_guest_contributor');
    $field_ex_staff = $row->getSourceProperty('field_ex_staff');
    if ($field_list[0]['value']) {
      $mapped_person_type = 'Staff';
    }
    elseif ($field_guest_contributor[0]['value']) {
      $mapped_person_type = 'Guest';
    }
    elseif ($field_ex_staff[0]['value']) {
      $mapped_person_type = 'Former staff';
    }
    $row->setSourceProperty('mapped_person_type', $mapped_person_type);
  }

  // iied_d7_projects migration.
  if ($migration->id() == 'iied_d7_projects') {
    if ($row->getSourceProperty('nid') == "14066") {
      // For node 14066 we were seeing the error on migration:
      //   Array index missing, extraction failed for
      //   'array( 'id' => '873', 'revision_id' => '874', )'.
      //   Consider adding a `default` key to the configuration.
      //
      // I think this is due to an empty paragraph on the
      // field_full_width_media field, so here we simply set that source
      // property to an empty array, which seems to solve the issue.
      $row->setSourceProperty('field_full_width_media', []);
    }
  }
  // iied_d7_news_media migration.
  if ($migration->id() == 'iied_d7_news_media') {
    // Source node 3979 is giving an error, which seems to be referencing a
    // project id 4554 which does not seem to exist.
    if ($row->getSourceProperty('nid') == '3979') {
      $project = $row->getSourceProperty('field_project_number_reference');
      if (is_array($project) && $project[0]['target_id'] == '4554') {
        $row->setSourceProperty('field_project_number_reference', []);
      }
    }
  }
  //iied_d7_person_para_researcher_profiles
  if ($migration->id() == 'iied_d7_person_para_researcher_profiles') {
    $url = $row->getSourceProperty('field_link_value');
    $field_link_processed[0] = [
      'url' => trim($url),
      'title' => '',
      'attributes' => '',
    ];
    $row->setSourceProperty('field_link_processed', $field_link_processed);
  }
  // Collections terms migration.
  if ($migration->id() == 'iied_d7_terms_collection') {
    $tagline_value = $row->getSourceProperty('field_tagline');
    $trimmed_short_description = substr($tagline_value[0]['value'], 0, 255);
    $row->setSourceProperty('trimmed_short_description', $trimmed_short_description);
    // Add a redirect from, for example:
    // Source: https: //www.iied.org/localising-forest-climate-action
    // Target: https://pubs-dev.ac.iied.org/collection/localising-forest-climate-action
    $tid = $row->getSourceProperty('tid');
    $query = $source->getDatabase()->select('url_alias', 'ua')
      ->fields('ua', ['alias']);
    $query->condition('ua.source', 'taxonomy/term/' . $tid);
    $alias = $query->execute()->fetchField();
    if ($alias) {
      // Check if redirect exists
      $db = \Drupal\Core\Database\Database::getConnection();
      $query = $db->select('redirect', 'r');
      $query->fields('r', array('redirect_source__path'));
      $query->condition('redirect_source__path', $alias);
      $existing_redirect = $query->execute()->fetchField();
      if (!$existing_redirect) {
        Redirect::create([
          'redirect_source' => $alias,
          'redirect_redirect' => 'internal:/collection/' . $alias,
          'language' => 'und',
          'status_code' => '301',
        ])->save();
      }
    }
  }

  // Look up path aliases for node migrations.
  $node_migrations = [
    'iied_d7_articles',
    'iied_d7_blogs',
    'iied_d7_events',
    'iied_d7_news_media',
    'iied_d7_news_press',
    'iied_d7_projects',
  ];
  if (in_array($migration->id(), $node_migrations)) {
    $nid = $row->getSourceProperty('nid');
    $db = \Drupal\Core\Database\Database::getConnection();
    $query = $source->getDatabase()->select('url_alias', 'ua')
      ->fields('ua', ['alias']);
    $query->condition('ua.source', 'node/' . $nid);
    $alias = $query->execute()->fetchField();
    if (!empty($alias)) {
      $row->setSourceProperty('alias', '/' . $alias);
    }
  }

  // Image media migration.
  if ($migration->id() == 'iied_d7_media_images') {

    // Query image field tables to extract alt text where possible.
    $image_fields = [
      'field_main_image',
      'field_second_image',
      'field_gallery',
      'field_cover_image',
    ];
    $fid = $row->getSourceProperty('fid');
    $row->setSourceProperty('alt_text', 'No description available.');
    $row->setSourceProperty('title_text', 'No title available.');

    foreach ($image_fields as $image_field) {
      $query = $source->getDatabase()->select('field_data_' . $image_field, 'fdi')
        ->fields('fdi', [$image_field . '_alt', $image_field . '_title']);
      $query->condition($image_field . '_fid', $fid);
      $result = $query->execute()->fetchObject();
      if (!empty($result)) {
        $alt_value =  $result->{$image_field . '_alt'};
        if (strlen($alt_value) > 1) {
          $row->setSourceProperty('alt_text',$alt_value);
        }
        $title_value = $result->{$image_field . '_title'};
        if (strlen($title_value) > 1) {
          $row->setSourceProperty('title_text', $title_value);
        }
      }
    }

  }

}
