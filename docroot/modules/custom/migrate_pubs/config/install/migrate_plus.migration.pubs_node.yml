# Migration configuration for beer content.
id: pubs_node
label: IIED Publications nodes
migration_group: pubs
migration_tags:
  - pubs
source:
  plugin: pubs_node
  constants:
    SOURCE_DOMAIN: 'https://pubscopy.iied.org/pdfs/'
    DRUPAL_FILE_DIRECTORY: 'public://pdfs/migrate/'
    PDF_SUFFIX: '.pdf'
process:
  # Hardcode the destination node type (bundle) as 'publication'.
  uid:
    plugin: default_value
    default_value: 1
  type:
    plugin: default_value
    default_value: publication
# Skip row unless Status = A or N
  field_status:
    plugin: skip_on_value
    method: row
    not_equals: true
    source: Status
    value:
      - A
      - N
  title: Title
  field_short_title: ShortTitle
  _product_code: ProductCode
  _lit_code: LitCode
  field_product_code: '@_product_code'
  field_lit_code: '@_lit_code'
  field_author_s_:
    plugin: entity_lookup
    allow_multiple: true
    source: AuthorList
    entity_type: node
    bundle: author
    value_key: title

  'body/value': Abstract

  field_theme_s_:
    -
      plugin: get
      source:
        - Theme
        - Theme2
    -
      plugin: entity_lookup
      allow_multiple: true
      entity_type: taxonomy_term
      bundle: theme
      bundle_key: vid
      value_key: field_legacy_code

  field_tags:
    plugin: entity_lookup
    allow_multiple: true
    source: Keywords
    entity_type: taxonomy_term
    bundle: tags
    bundle_key: vid
    value_key: name
    ignore_case: true

  field_document_type:
    plugin: entity_lookup
    source: DocType
    entity_type: taxonomy_term
    bundle: document_type
    bundle_key: vid
    value_key: field_legacy_doctype

  field_publisher:
    -
      plugin: explode
      delimiter: ', '
      source: Publisher
    -
      plugin: entity_generate_multiple
      entity_type: node
      bundle: organisation
      value_key: title
      uid: 1

# PDF file import via https from source directory
  _field_pdf_path:
    plugin: concat
    source:
      - constants/SOURCE_DOMAIN
      - '@_product_code'
      - constants/PDF_SUFFIX

  field_pdf:
    plugin: file_import
    source: '@_field_pdf_path'
    destination: constants/DRUPAL_FILE_DIRECTORY
    skip_on_missing_source: true
    skip_on_error: true
    reuse: true
    uid: 1
  field_pdf/display:
    plugin: default_value
    default_value: 1

destination:
  plugin: entity:node

# The general rule of thumb is that any migrations referenced by migration
# process plugins should be required here.
migration_dependencies:
  optional:
    - pubs_themes
    - pubs_tags
    - pubs_authors
    - pubs_doctypes
