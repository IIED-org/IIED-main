/*!
 * Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see https://ckeditor.com/legal/ckeditor-oss-license
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CKEditor5=t():(e.CKEditor5=e.CKEditor5||{},e.CKEditor5.realtimeAdapter=t())}(self,(()=>(()=>{"use strict";var e={d:(t,i)=>{for(var o in i)e.o(i,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:i[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>o});const i=class{constructor(e){this.editor=e,this.elementId=null,void 0!==this.editor.sourceElement&&(this.elementId=this.editor.sourceElement.dataset.ckeditor5PremiumElementId)}processCollaborationCommandDisable(e){if(!this.isCollaborationDisabled())return!1;const t=this.editor.commands._commands.get(e);return void 0===t||t.forceDisabled("premium-features-module"),!0}processRevisionDisable(){return!!this.isCollaborationDisabled()&&(this.editor.plugins.has("RevisionTracker")&&(this.editor.plugins.get("RevisionTracker").isEnabled=!1),!0)}isCollaborationDisabled(){return void 0!==drupalSettings.ckeditor5Premium&&void 0!==drupalSettings.ckeditor5Premium.disableCollaboration&&!0===drupalSettings.ckeditor5Premium.disableCollaboration}getEditorParentContainer(e){let t=document.getElementById(e);for(;t&&void 0!==t&&void 0!==t.classList&&!t.classList.contains("ck-editor-container");)t=t.parentElement;return t&&void 0!==t?t.parentElement:null}getSourceDataSelector(e){return{trackChanges:".track-changes",comments:".comments",revisionHistory:".revision-history",revisionHistoryContainer:".revision-history-container",resolvedSuggestionsComments:".resolved-suggestions-comments"}[e]+"-data"+`[data-ckeditor5-premium-element-id="${this.elementId}"]`}};const o={RealtimeAdapter:class{constructor(e){this.editor=e,this.submitElements=[],this.formElement=this.editor.sourceElement.closest("form"),this.disabledAttributeName="data-ckeditor5-block-"+this.editor.id,this.editor.config._config.realtime.readonly?this.editor.enableReadOnlyMode("realtime"):void 0!==this.editor.sourceElement&&(this.storage=new i(e),void 0!==drupalSettings.ckeditor5ChannelId&&void 0!==this.editor.sourceElement.dataset.ckeditorfieldid&&void 0!==drupalSettings.ckeditor5ChannelId[this.editor.sourceElement.dataset.ckeditorfieldid]&&(this.editor.config._config.collaboration={channelId:drupalSettings.ckeditor5ChannelId[this.editor.sourceElement.dataset.ckeditorfieldid]},this.setPresenceListContainer(),this.disableSubmitButtons()))}static get pluginName(){return"RealtimeAdapter"}init(){if(this.editor.config._config.realtime.readonly)return;if(void 0===this.editor.sourceElement)return;const e=this.editor,t=e.plugins.has("RealTimeCollaborativeEditing"),i=e.plugins.has("SourceEditing")||e.plugins.has("SourceEditingEnhanced");t&&i&&(console.info("The Source editing plugin is not compatible with real-time collaboration, so it has been disabled. If you need it, please contact us to discuss your use case - https://ckeditor.com/contact/"),e.plugins.has("SourceEditing")&&e.plugins.get("SourceEditing").forceDisabled("drupal-rtc"),e.plugins.has("SourceEditingAdvanced")&&e.plugins.get("SourceEditingAdvanced").forceDisabled("drupal-rtc"));let o=this.getFieldWrapper(this.editor.sourceElement.id);o&&(this.textFormatSelect=o.querySelector(".js-filter-list"),this.textFormatSelect&&this.textFormatSelect.addEventListener("change",this.changeEditor.bind(this)))}getFieldWrapper(e){const t=document.getElementById(e);return t?t.closest(".js-text-format-wrapper"):null}changeEditor(e){const t=this.editor.config._config.collaboration.channelId,i=new XMLHttpRequest,o="/ckeditor5-premium-features-realtime-collaboration/flush-session/"+t;i.open("DELETE",o),i.send()}setPresenceListContainer(){const e=this.editor.config._config.presenceList;if(e&&void 0!==e){if(!e.container){const t=this.editor.sourceElement.id+"-presence-list-container",i=document.getElementById(t);if(i)e.container=i;else{const i=this.editor.sourceElement.closest(".form-item"),o=document.createElement("div");o.setAttribute("class","ck-presence-list-container"),o.setAttribute("id",t),i.parentNode.insertBefore(o,i.previousSibling),e.container=o}}e.collapseAt||(e.collapseAt=drupalSettings.presenceListCollapseAt)}}clearPresenceListContainer(){const e=this.editor.config._config.presenceList.container;e&&(e.innerHTML="")}afterInit(){if(!this.editor.config._config.realtime.readonly&&void 0!==this.editor.sourceElement){if(this.storage.processCollaborationCommandDisable("trackChanges"),this.storage.processCollaborationCommandDisable("addCommentThread"),this.checkIfInitialDataChanged(),drupalSettings.ckeditor5Premium.notificationsEnabled){this.editor.sourceElement.closest("form").addEventListener("submit",(()=>{const e=this.editor.plugins.has("CommentsRepository"),t=this.editor.plugins.has("TrackChanges"),i=this.editor.plugins.has("RealtimeCommentNotifications");if(!e||!t)return;const o=".track-changes",s=".comments",r=`[data-ckeditor5-premium-element-id="${this.editor.sourceElement.dataset.ckeditor5PremiumElementId}"]`;if(t){let e=new Map;const t=o+"-data",i=this.editor.plugins.get("TrackChanges").getSuggestions({skipNotAttached:!1}),s=document.querySelector(t+r);for(let t in i){let o=this.cloneSuggestionForBackend(i[t]);null==i[t].head||null==i[t].next&&null==i[t].previous||(o.attributes.head=i[t].head),o.attributes.items=i[t].getItems(),e.set(i[t].id,i[t])}s.value=JSON.stringify(Array.from(e.values()))}if(e&&!i){const e=s+"-data",t=this.editor.plugins.get("CommentsRepository");document.querySelector(e+r).value=JSON.stringify(t.getCommentThreads({skipNotAttached:!0,skipEmpty:!0,toJSON:!0}))}}))}this.editor.on("ready",(()=>{let e=this.editor.sourceElement.dataset.editorActiveTextFormat,t=drupalSettings.ckeditor5Premium.tracking_changes.default_state;void 0!==t[e]&&t[e]&&this.editor.execute("trackChanges"),this.enableSubmitButtons()}))}}destroy(){this.editor.config._config.realtime.readonly||((this.textFormatSelect||void 0!==this.textFormatSelect)&&this.textFormatSelect.removeEventListener("change",this.changeEditor.bind(this)),this.clearPresenceListContainer(),this.submitElements=[])}checkIfInitialDataChanged(){const e=this.editor.config._config.initialData;this.editor.on("ready",(()=>{e!==this.editor.getData()&&this.editor.sourceElement.setAttribute("data-editor-value-is-changed",!0)}))}disableSubmitButtons(){this.formElement&&(this.submitElements=this.formElement.querySelectorAll('input[type="submit"], button[type="submit"]'),Array.from(this.submitElements).forEach((e=>{e.disabled=!0,e.setAttribute(this.disabledAttributeName,!0)})))}enableSubmitButtons(){this.formElement&&Array.from(this.submitElements).forEach((e=>{e.removeAttribute(this.disabledAttributeName),this.hasDataBlockedAttribute(e)||(e.disabled=!1)}))}hasDataBlockedAttribute(e){if(!e||!e.hasAttributes())return!1;for(let t of e.attributes)if(t.name.startsWith("data-ckeditor5-block-"))return!0;return!1}cloneSuggestionForBackend(e){return{id:e.id,type:e.type,authorId:e.authorId,createdAt:e.createdAt,hasComments:e.hasComments,data:e.data,attributes:e.attributes}}}};return t=t.default})()));